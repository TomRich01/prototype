<script src="ods.js"></script>
<script src="jszip.js"></script>
<script src="shim.js"></script>
<script src="xlsx.js"></script>
<script src="http://craigwayne.github.io/nexus/js/nexus.js"></script>

<style>
#map-canvas{
  width: 100%;
  height: 300px;
  background: rgb(255, 0, 0);
}
</style>

<title>Excel to Google Maps</title>

<fieldset class=step>
    <legend>Step 1: Select your XLS(X) file</legend>
    <input type="file" name="xlfile"></p>
</fieldset>

<fieldset class=step>
    <legend>Step 2: Read Data</legend>
    <input type=button onclick="nexus.file.read()" value="Process">
</fieldset>

<fieldset>
    <legend>Step 3: Tabular Result</legend>
</fieldset>

<pre id="out"></pre>

<div class="nexus google map" id="map-canvas"></div>

<script>

//http://stackoverflow.com/questions/8588563/adding-custom-properties-to-a-function
var nexus = function(){
	
	//nexus google maps module
	nexus.google = {};
	nexus.google.maps = {
		
		api_url     : "https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true&callback=nexus.google.maps.post_install",
		installed   : false,
		options     : {
			zoom: 8
		},
		
		post_install: function(){
			nexus.debug("Google Map API installtion complete...");
			nexus.google.maps.installed = true;
			nexus.debug("Google Map API installed?",nexus.google.maps.installed);
		},
		
		create      : function(element){
			if(!nexus.google.maps.installed){
				nexus.google.maps.install(function(){
					nexus.google.maps.create(element);
				});
			}
			else if(element instanceof HTMLElement){
				nexus.debug("creating the map....");

				var map_options = array_m

				element.nexus			 = element.nexus || {};
				element.nexus.google	 = element.nexus.google || {};
				element.nexus.google.map =  new google.maps.Map(element,nexus.google.map.options);
				//set the center using the google maps new google.maps.LatLng(-34.397, 150.644)
				return element.nexus.google.map;
				nexus.debug("Finished creating map...");
			}
			else{

			}

		},
		
		install     : function(callback){
			nexus.debug("Installing Google Map API...", nexus.google.maps.api_url);
			nexus.scripts.install(nexus.google.maps.api_url);
		},
		
		init        : function(){
			//check if the google map script is installed
			for(var i=0; i<document.scripts.length; i++){
				if(document.scripts[i].src){
					if(document.scripts[i].src == nexus.google.maps.api_url) return; 
				}
			}
			nexus.google.maps.install();
		}
	};
	
	//nexus file module
	file:{
        read:function(){
            
            //so far this is only catering for xlsx to json
            var files = document.querySelector("input[type=file]").files;
            var f = files[0];
            var reader = new FileReader();
            reader.onload = function(e) {
                var data = e.target.result;
                var worker = new Worker('./xlsxworker2.js');
                worker.onmessage = function(e) {
                    switch(e.data.t) {
                        case 'ready': break;

                        case 'e': console.error(e.data.d); break;
                        default: 

                            var o = "", l = 0, w = 10240;
                            for(; l<e.data.byteLength/w; ++l) o+=String.fromCharCode.apply(null,new Uint16Array(e.data.slice(l*w,l*w+w)));
                            o+=String.fromCharCode.apply(null, new Uint16Array(e.data.slice(l*w)));

                            xx=o.replace(/\n/g,"\\n").replace(/\r/g,"\\r"); 
                            
                            var temp_2 = JSON.parse(xx);
                            var temp_1 = {};
                            temp_2.SheetNames.forEach(function(sheetName) {
                                var roa = XLSX.utils.sheet_to_row_object_array(temp_2.Sheets[sheetName]);
                                if(roa.length > 0){
                                    temp_1[sheetName] = roa;
                                }
                            });
                            
                            var output = JSON.stringify(temp_1, 2, 2);
                            out.innerText = output;
                            break;
                    }
                };

                var b = new ArrayBuffer(data.length*2), v = new Uint16Array(b);
                for (var i=0; i != data.length; ++i) v[i] = data.charCodeAt(i);
                var val =  [v, b];

                worker.postMessage(val[1], [val[1]]);
            };
            reader.readAsBinaryString(f);
        }
        
    },
		
	//nexus json module
    json:{
		to_table:function(params){}
    },
	
	//nexus jquery module
	nexus.jquery_url = "http://code.jquery.com/jquery-1.11.2.min.js";
	
	nexus.debug = function(title,message){
        if(window.location.search.indexOf("debug=true") < 0) return;
        
		if(message) console.debug(title,message);
		else console.debug(title);
    };
	
	//nexus scripts module
	nexus.scripts = {};
	nexus.scripts.install = function(src){
		nexus.debug("Installing Script",src);
		var script	= document.createElement("script");
		script.type = "text/javascript";
		script.src	= src;
		document.body.appendChild(script);
		return script;
	};
	
	nexus.init = function(){
		nexus.debug("Initializing nexus...");
		//install jquery library
		nexus.scripts.install(nexus.jquery_url);
	};
	nexus.init();
};

nexus();
</script>