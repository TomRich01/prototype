<script src="ods.js"></script>
<script src="jszip.js"></script>
<script src="shim.js"></script>
<script src="xlsx.js"></script>
<script src="http://craigwayne.github.io/nexus/js/nexus.js"></script>

<style>
#map-canvas{
  width: 100%;
  height: 600px;
  background: rgb(255, 0, 0);
}
</style>

<title>Excel to Google Maps</title>

<fieldset class=step>
    <legend>Step 1: Select your XLS(X) file</legend>
    <input type="file" name="xlfile"></p>
</fieldset>

<fieldset class=step>
    <legend>Step 2: Read Data</legend>
    <input type=button onclick="nexus.file.read()" value="Process">
</fieldset>

<fieldset>
    <legend>Step 3: Tabular Result</legend>
</fieldset>

<pre id="out"></pre>

<div class="nexus google map" id="map-canvas"></div>

<script>

var nexus = {
    debug:function(title,message){
        if(window.location.search.indexOf("debug=true") < 0) return;
        
        message = message ? title + " | " + message : title;
        console.debug(message);
    },
    file:{
        read:function(){
            
            //so far this is only catering for xlsx to json
            var files = document.querySelector("input[type=file]").files;
            var f = files[0];
            var reader = new FileReader();
            reader.onload = function(e) {
                var data = e.target.result;
                var worker = new Worker('./xlsxworker2.js');
                worker.onmessage = function(e) {
                    switch(e.data.t) {
                        case 'ready': break;

                        case 'e': console.error(e.data.d); break;
                        default: 

                            var o = "", l = 0, w = 10240;
                            for(; l<e.data.byteLength/w; ++l) o+=String.fromCharCode.apply(null,new Uint16Array(e.data.slice(l*w,l*w+w)));
                            o+=String.fromCharCode.apply(null, new Uint16Array(e.data.slice(l*w)));

                            xx=o.replace(/\n/g,"\\n").replace(/\r/g,"\\r"); 
                            
                            var temp_2 = JSON.parse(xx);
                            var temp_1 = {};
                            temp_2.SheetNames.forEach(function(sheetName) {
                                var roa = XLSX.utils.sheet_to_row_object_array(temp_2.Sheets[sheetName]);
                                if(roa.length > 0){
                                    temp_1[sheetName] = roa;
                                }
                            });
                            
                            var output = JSON.stringify(temp_1, 2, 2);
                            out.innerText = output;
                            break;
                    }
                };

                var b = new ArrayBuffer(data.length*2), v = new Uint16Array(b);
                for (var i=0; i != data.length; ++i) v[i] = data.charCodeAt(i);
                var val =  [v, b];

                worker.postMessage(val[1], [val[1]]);
            };
            reader.readAsBinaryString(f);
        }
        
    },
    json:{
    
        to_table:function(params){
            
        }
    
    },
    google:{
        map:{
            
            //api_url: "https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true&callback=initialize",
            api_url     : "https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true",
            installed   : false,
            options     : {
                zoom: 8,
                latitude: -34.397,
                longitude: 150.644,
                center:null
            },
            init        : function(){
                //check if the google map script is installed
                for(var i=0; i<document.scripts.length; i++){
                    if(document.scripts[i].src){
                        if(document.scripts[i].src == nexus.google.map.api_url) return; 
                    }
                }
                nexus.google.map.install();
            },
            install     : function(callback){
                nexus.debug("Installing Google Map API...", nexus.google.map.api_url);
                
                var script  = document.createElement("script");
                script.type = "text/javascript";
                script.src  = nexus.google.map.api_url;
               
                script.addEventListener("load",function(){
                    nexus.debug("Google Map API installtion complete...");
                    nexus.google.map.installed = true;
                    if(callback){callback();;}
                    nexus.debug(nexus.google.map.installed);
                },false);
                
                document.body.appendChild(script);
            },
            create      : function(element){
                if(!nexus.google.map.installed){
                    nexus.google.map.install(function(){
                        nexus.google.map.create(element);
                    });
                }
                else if(element instanceof HTMLElement){
                    nexus.debug("creating the map....");
                    //console.debug(google);
                    //var map =  new google.maps.Map(element);
                    //set the center using the google maps new google.maps.LatLng(-34.397, 150.644)
                    //return map;
                    nexus.debug("Finished creating map...");
                }
   
            }
            
        }
    }
};    
    

</script>